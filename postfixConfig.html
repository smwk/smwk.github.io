<html>
  <head>
    <title>Graph and PowerShell Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
       
    <style>
      body{
        margin: 0px;
        padding: 0px;
    }
 
h1 {
        margin-top: 0px;
    }

	    ul {
  list-style-position: outside;
}
	  
      .dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  text-align:left;
  background-color: #ffffff;
  font-family:Montserrat, sans-serif;
  font-size:13px;
  min-width: 380px;
  box-shadow: 0px 2px 2px 0px rgba(0,0,0,0.2);
  padding: 6px 6px;
  z-index: 1;
}

.dropdown:hover .dropdown-content {
  display: block;
}
      
	    
a.dropbtn:link {color: #564c4d; text-decoration: none;}
a.dropbtn:visited {color: #564c4d; text-decoration: none;}
a.dropbtn:hover {color: #564c4d; text-decoration: none;}
	    
a.two:link {color: #564c4d; text-decoration: none;}
a.two:visited {color: #564c4d; text-decoration: none;}
a.two:hover {color: #447EAE; text-decoration: none;}
	    
	.content { font-family:verdana; font-size:12px; color:#564c4d; width:850px; text-align:left; }
	.headline { font-family:verdana; font-size:22px; color:#564c4d; width:850px; text-align:left; }
	.datestamp { font-family:verdana; font-size:10px; color:#564c4d; width:850px; text-align:left; }
	.imagecaption { font-style: italic; }
	.imageMain { border: 5px solid #564c4d; }
	.indexTable td { font-family:verdana; font-size:12px; color:#564c4d; }
	.code { font-family: 'Source Code Pro', monospace; font-size:12px; color:#000; border: 2px solid #000; background-color:#cecece; padding:6px; }

	   .table1 td:first-child {
  font-weight: bold;
}
	    
      </style>
    
  </head>
  
  <body>
    
    <table style='width:100%; padding:0px; border-collapse: collapse;'>
      <tr><td style='height:25px; color:#564c4d; width:50%; font-size:25px; font-family:Montserrat, sans-serif; text-align:left;'><a href='index.html' class=dropbtn><img src='giraffe3.png' style='height:55px; padding:10px; vertical-align:middle; border:0px;'>Graph and PowerShell Blog</a></td>
        
        <td style='width:50%; color:#564c4d; font-size:15px; font-family:Montserrat, sans-serif; text-align:right; padding-right:300px;'>
		
		 
	<div class="dropdown">
		<a href='' class="dropbtn">Articles</a>
  <div class="dropdown-content" style='line-height: 1.6;'>
	  <details open>
		    <summary><b>2024</b><br></summary>
	<a href="postfixConfig.html" class=two>Advanced Postfix configuration</a><br>
	  <a href="installExchange2019.html" class=two>Installing Exchange 2019 in Azure Landing Zone</a><br>
	  <a href="upgradePHP.html" class=two>Upgrading PHP on Windows</a><br>
	  <a href="postfixRelay.html" class=two>Adding a Postfix server for relay to O365</a><br>
	  <a href="integratedApps.html" class=two>O365 Integrated Apps troubleshooting</a><br>
	  <a href="DominoO365.html" class=two>Domino and O365 Co-existence</a><br>
	  <a href="ADdelegate.html" class=two>Delegate Control in AD</a><br>
	  <a href="hverelay.html" class=two>App mail relay via HVE</a><br>
 <a href="hve.html" class=two>Setting up Mail Relay with HVE</a><br>
    <a href="bimi.html" class=two>Getting BIMI certified</a><br>
    <a href="occam.html" class=two>Orbea Occam SL H30</a><br>
    <a href="freesat.html" class=two>Installing FreeSat and Saorview</a><br>
    <a href="broadband.html" class=two>Changing broadband provider</a><br>
    <a href="DINtimer.html" class=two>Replacing a DIN timer on fuseboard</a><br>
    <a href="desktopNotifications.html" class=two>Outlook Desktop Notifications stop working</a><br>
    <a href="outlookFolders.html" class=two>Outlook folders keep moving sort order</a><br>
    <a href="runbooks.html" class=two>Teams report uploading to SharePoint with Runbooks</a><br>
	  <a href="teamsApplication.html" class=two>Teams PowerShell module can't run CS cmd as App</a><br>
	  </details>
	  
	  <details>

    <summary><b>2023</b><br></summary>
<a href="mapSharedMailbox.html" class=two>Cannot map new Shared Mailboxes in O365</a><br>
	<a href="exchangeCertRenew.html" class=two>Renewing an Exchange 2016 certificate</a><br>
	<a href="compliancePowershell.html" class=two>Connect to Compliance PowerShell behind a Proxy</a><br>
	<a href="sensitivityLabelError.html" class=two>Sensitivity Label not shown in Outlook Client</a><br>
	<a href="roomFinderError.html" class=two>Room Finder Error in Outlook</a><br>
	<a href="teamsRoom.html" class=two>Teams not showing Rooms</a><br>
	<a href="teamsFile.html" class=two>Teams unable to open file</a><br>
	<a href="reviewQuarantine.html" class=two>Unable to review quarantined mails for shared mailbox</a><br>
	<a href="setLocale.html" class=two>Set Locale for various Apps</a><br>
	<a href="delegateSentItems.html" class=two>Delegate Sent Items placed into external Tenant</a><br>
	<a href="microsoftSupport.html" class=two>Overview of Microsoft Support cases</a><br>
	<a href="centralizedMail.html" class=two>When centralized mail sends via O365</a><br>
        <a href="DNScleanup.html" class=two>Cleaning up your Windows DNS server</a><br>
        <a href="oneDriveLocale.html" class=two>Set OneDrive for Business Locale</a><br>
	<a href="o365migration.html" class=two>O365 Migration Tips</a><br>
	<a href="o365reporting.html" class=two>Reporting on successful Azure logons</a><br>
	<a href="iisQueue.html" class=two>IIS Mapi Queue full with NetScaler</a><br>
        <a href="o365cert.html" class=two>Secure Office365 reports with a certificate</a><br>
        <a href="graphMail.html" class=two>Using Graph to send emails with inline images</a><br>
        <a href="charts.html" class=two>Visualizing Graph data with Google Charts</a><br>
        <a href="alwaysOn.html" class=two>Keeping a log of NetScaler AlwaysON connections</a><br>
</details>
  
  </div>
</div>	
		
		| <a href='about.html' class=two>About</a> | <a href='links.html' class=two>Links</a></td></tr> 
      <tr><td style='height:1px; color:#564c4d; width:100%; border-bottom: 1px solid;' colspan=2></td></tr>
      <tr><td style='text-align:center; width:100%; padding-top:30px; padding-left:30px;' colspan=2>
     
	      

         <div class=headline>Advanced Postfix Config</div>
	      <div class=datestamp>17-Jun-24</div>
        <div class=content><br>
Having <a href='https://smwk.github.io/postfixRelay.html'>setup Postfix</a> recently I found the process very straightforward, with a lot of options for configuration. Deciding to dig a bit deeper I looked at the following advanced settings:<br>
          <br>
          <li><A href="#anchor-one">Full certificate chain</A></li>
          <li><A href="#anchor-two">Adding DKIM to outgoing mails</A></li>
		<li><A href="#anchor-three">Allow Internet access through web proxy</A></li>
		<li><A href="#anchor-four">Setup remote access with PowerShell</A></li>
		<li><A href="#anchor-five">Apps that can't relay off Postfix</A></li>
          <br>
		<br>
          <b><A name="anchor-one">Full Certificate Chain</a></b><br>
          Most articles you see for setting up your certificate to encrypt emails would point you to having the following config:<br>
          <br>
          <div class=code>
smtp_tls_key_file = /etc/ssl/private.key<br>
smtp_tls_cert_file = /etc/ssl/relay_cert.cer<br>
smtp_tls_CAfile = /etc/ssl/inter_cert.cer<br>
          </div>
          <br>
          This has been deprecated by Postfix, and you should now use a certificate chain. This means you include your private key, cert, intermediate cert, and if needed your root cert all under one file.<br>
          <br>
          While not difficult to setup, you need to be careful to get the certs/keys in the correct order, otherwise, it simply won't work.<br>
          <br>
          <div class=code>
        smtp_tls_chain_files = /etc/postfix/chain.pem<br>
    smtpd_tls_chain_files = /etc/postfix/chain.pem<br>
            <br>
            <i>.pem order</i><br>
            Private Key<br>
            Cert<br>
            Intermediate Cert<br>
            Root Cert (if needed)<br>
          </div>
          <br>
		<br>
		<br>
          <b><A name="anchor-two">Adding DKIM to Outgoing Mails</A></b><br>
		When you relay mails into Office365 via a connector your mail is still subject to DMARC checks. So the first step will probably be to add the public IP of the relay server so that the SPF check will pass.<br>
		<br>
		Depending on how your DMARC record is setup, that may be enough. But what if your DMARC also requires DKIM to pass, or you just want the extra security of DKIM? OpenDKIM has this covered, the steps to install and configure are:<br>
		<br>
		<li>Install via bash: apt-get install opendkim opendkim-tools</li>
		<li>Generate private key: opendkim-genkey -t -s prelay -d domain.com</li>
		<li>Copy private key to /etc/Postfix/dkim.key</li>
		<li>Set opendkim as owner of key file: chown opendkim:opendkim /etc/postfix/dkim.key</li>
		<li>Also copy the generated DNS record file to the Postfix directory for easy editing</li>
		<li>Set /etc/opendkim.conf file (see below)</li>
		<li>Add DKIM entries to /etc/Postfix/main.cf in Postfix (see below)</li>
		<li>Create DKIM record in DNS</li>
		<br>
		<i>Troubleshooting</i><br>
		<li>Check file permissions on key file: ls -la /etc/postfix/dkim.key</li>
		<li>View log file: journalctl -u opendkim -o short-iso</li>
		<li>Restart service: service opendkim reload</li>
		<li>Install DNS tools: sudo apt-get install dnsutils</li>
		<li>Check DNS record with DIG: dig -t txt relay._domainkey.domain.com</li>
		<br>
		<div class=code>
		/etc/opendkim.config<br>
		====================<br>
		Domain                  domain.com<br>
		KeyFile                 /etc/postfix/dkim.key<br>
		Selector                relay<br>
		SOCKET                  inet:8891@localhost<br>
		</div>
		* There is some debate if SOCKET should be set under /etc/default/opendkim, but this seems to have been there for legacy reasons and is no longer needed.<br>
		<br>
		<div class=code>
		/etc/postfix/main.cf<br>
		====================<br>
		milter_default_action = accept<br>
		milter_protocol = 6<br>
		smtpd_milters = inet:localhost:8891<br>
		non_smtpd_milters = inet:localhost:8891<br>
		</div>
		<br>
		<img src=postfixConfig01.png class=ImageMain>
		<div class=ImageCaption>↑ Usually there are three lines of text in double quotes, remove the line breaks and quotes before adding the DNS TXT record. The t=y is for testing and can be removed.</div>
        <br>
		If you have a transport rule in Exchange that adds a disclaimer to all external mails, then you will want to exclude the Postfix mails (exclude by IP) in order not to break the DKIM body.<br>
  <br>
		<br>
		<br>
		<b><A name="anchor-three">Allow Internet access through web proxy</A></b><br>
		If your internet access is via an authenticated proxy then you will need to add your credentials in 2 places:<br>
		<br>
		<div class=code>
			General: sudo nano ~/.bashrc<br>
			============================<br>
		proxy_http=username:password@proxy-server-ip:port<br>
			proxy_https=username:password@proxy-server-ip:port<br>
			<br>
			Proxy for APT: /etc/apt/apt.conf<br>
			===============================<br>
			Acquire::http::Proxy "http://[username]:[password]@ [proxy-web-or-IP-address]:[port-number]";<br>
			Acquire::https::Proxy "http://[username]:[password]@ [proxy-web-or-IP-address]:[port-number]";<br>
		</div>
		<br>
		If you don't want to worry about password changes then I would suggest setting up a service account in Active Directory and setting the password to never expire.<br>
	<br>
		<br>
		<br>
		<b><A name="anchor-four">Setup remote access with PowerShell</A></b><br>
		When setting up Postfix I decided to have a separate log file just from Postfix instead of going into the more general Mail.log. While this is set in the Postfix settings it doesn't control things like the date format, which still comes from the system itself (systemd).<br>
		<br>
		In Ubuntu 24.04 the default logs are accessed via journalctl, and not the popular rsyslog. Via bash you can use '-output short-iso' to set the date format to ISO, but this will not change the settings for the postfix.log file.<br>
		<br>
		While I could have spent more time on this I decided to go with what I know and setup <a href='https://learn.microsoft.com/en-us/powershell/scripting/install/install-ubuntu?view=powershell-7.4'>remote PowerShell</a>. With this, I could archive the logs daily and parse the log with tools that I already know.<br>
		<br>
		I won't go into all of the details but having an auth key from the Windows server helps greatly with scripting. A combination of Bash command and PowerShell tools gives lots of options to work with.<br>
		<br>
		<div class=code>
		PowerShell on Ubuntu<br>
		====================<br>
		sudo dpkg --install --ignore-depends=libicu72 powershell_7.4.2-1.deb_amd64.deb # currently there is a compatibility issue so install with this command<br>
		<br>
		

		</div>
		<br>
	<br>
		<br>
		<b><A name="anchor-five">Apps that can't relay off Postfix</A></b><br>
		When migrating the apps from Exchange to Postfix I didn't expect there to be any issues, despite some of the apps being nearly 20 years old. When moving an Alcatel Voicemail server I found the following error in the log:<br>
		<br>
		<div class=code>
		/var/logs/postfix.log<br>
		=====================<br>
		TBC<br>

		</div>
		<br>
		While I can't be certain, the most likely cause is a recent vulnerability called <a href='https://www.postfix.org/smtp-smuggling.html'>SMTP Smuggling</a>. To allow the server to relay you could try the following setting:<br>
		<br>
		<div class=code>
			etc/postfix/main.cf<br>
			===================<br>		
		smtpd_forbid_unauth_pipelining = no<br>
		</div>
		<br>
		But in my case, I didn't want to reduce the security of Postfix, and as the server will be retired in a few months, I decided to install <a href='https://learn.microsoft.com/en-us/biztalk/install-and-config-guides/appendix-d-create-the-smtp-server'>SMTP Server</a> on IIS.<br>
		<br>
		It's no longer officially supported by Microsoft, but it is easy to configure. Probably a little worrying that there is no protection against SMTP Smuggling, but it will only be used internally.<br>
		<br>
          </div>
          
          </td>
         
        </td></tr>
    </table> 
    

    
    
    
  </body>
  
  
  
</html>
