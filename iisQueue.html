<html>
  <head>
  <title>PowerShell & Graph Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
      body { margin: 0; padding: 0; background-color:#c9c7c7; }
a:link {
  color: #646d8c;
}
        
/* visited link */
a:visited {
  color: #646d8c;
}   
  
/* mouse over link */
a:hover {
  color: #646d8c;
}
      
a.one:link {color: #e09738; text-decoration: none;}
a.one:visited {color: #e09738;  text-decoration: none;}
a.one:hover {color: #e09738;}
      
a.two:link {color: #646d8c; text-decoration: none; font-size:14px;}
a.two:visited {color: #646d8c;  text-decoration: none; font-size:14px;}
a.two:hover {color: #646d8c; text-decoration: none; font-size:14px;}
      
.headerTable
{
    width:100%;
    color:#e09738;
    font-family: arial;
    font-size:12px;
}
      .headline
      {
       font-family:arial;
        font-size:20px;
        color:black; 
      }
      .articleContent
      {
       font-family:arial;
        font-size:13px;
        color:black;
      }
      .imageCaption
      {
       color:#1c1c1c;
       font-style: italic;
        font-siz:12px;
      }
 .horizontal_dotted_line{
  border-bottom: 4px dotted;
  width: 95%;
   text-align:center;
   margin: auto;
} 

       /* Navbar container */
.navbar {
  overflow: hidden;
  background-color: #333;
  font-family: Arial;
}

/* Links inside the navbar */
.navbar a {
  float: left;
  font-size: 16px;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

/* The dropdown container */
.dropdown {
  float: left;
  overflow: hidden;
}

/* Dropdown button */
.dropdown .dropbtn {
  font-size: 16px;
  border: none;
  outline: none;
  color: white;
  padding: 14px 16px;
  background-color: inherit;
  font-family: inherit; /* Important for vertical align on mobile phones */
  margin: 0; /* Important for vertical align on mobile phones */
}

/* Add a red background color to navbar links on hover */
.navbar a:hover, .dropdown:hover .dropbtn {
  background-color: orange;
}

/* Dropdown content (hidden by default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  float: none;
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  text-align: left;
}

/* Add a grey background color to dropdown links on hover */
.dropdown-content a:hover {
  background-color: #ddd;
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
} 


    </style>
    
    
  </head>
<body>
  <table class=headerTable>
    <tr>
      <td style='font-size:50px;padding:30px;color:black;width:120px;vertical-align:top;' rowspan=2>PowerShell<br> & Graph<br>Blog</td>
      

    <td style='width:100%;'>
	    <table style='width:100%;'>
		<tr>
	
	      <td style='color:#e09738;padding30px;font-size:15px;height:30px;width:100%;' class=one><br><br>
      
 <div class="navbar">
 
  <div class="dropdown">
    <button class="dropbtn">Articles
      <i class="fa fa-caret-down"></i>
    </button> 
    <div class="dropdown-content">
	<a href="iisQueue.html" class=two>IIS Mapi Queue full with NetScaler</a>
        <a href="o365cert.html" class=two>Secure Office365 reports with a certifificate</a>
        <a href="graphMail.html" class=two>Using Graph to send emails with inline images</a>
        <a href="charts.html" class=two>Visualizing Graph data with Google Charts</a>
        <a href="alwaysOn.html" class=two>Keeping a log of NetScaler AlwaysON connections</a>
        <a href="DNScleanup.html" class=two>Cleaning up your Windows DNS server</a>
    </div>
  </div>
    <a href="about.html">About</a>
  <a href="links.html">Links</a>
</div> 

 
        
      </td>
 </tr>
    <tr>
    
      <td style='padding-right:200px; width:100%;'><div class=headline id="AzureLogons"><br><b>IIS Mapi Queue full with NetScaler</b></div>
        <div class=articleContent>A recent issue I came across appeared to happen at random times during the working week. Outlook cleints would be disconnected for up to 30 minutes before returning to normal. 
		As the issue seemed to only occur after a patching cycle the focus at first was on what was in the those patches and was there an incompatibility with Outlook. 
		Evenetually I narrowed down the issue with the help of the HTTP_Err logs (c:\windows\logs\HTTP_Err\) which are never deleted, so helps with investigations. 
		<br><br>
		Within these logs we could see a 400.2 error, which translates to queue full. So it appeared that after 4 years of running Exchange 2016 we were hitting a new limit for the system. With the help of this <a href=>blog</a> I was able to setup a PowerShell script to monitor the number of MAPI connections we were receiving. 
		It soon became clear that when the connections were hitting 4,000 plus that the queue limit would be reached and as a result the health monitor on the NetScaler would also fail. 
		This would result in the failover of client connections to the other active node which would also eventually hit 4,000 connections and also fail. 
		<br><br>
		My question to the NetScaler admin was if the connection is supposed to be load balanced then why were all the connections hitting one server with less than 10 connections hitting the other server? 
		We opened a support call with Citrix and eventually got speaking to the right engineer, he explained that we had to choose 'Round Robin' and not xxxxx as shown on some blogs for setting up NetScaler. 
		<br><br>
		After we made the change we now see the connections evenly distributed and we no longer see the queue full error messages on IIS.<br>
          <br><br> 
                  <div class=tags>Tags: IIS, NetScaler, MAPI</div><br>
                  <br>
                  <div class="horizontal_dotted_line"></div><br>
                  <br>
        </div>
	      
	  
	    </td>
	</tr>
	</table>
	      
      </td>
    </tr>
  </table>
</body>
</html>

