
<html>
  <head>
  <title>PowerShell & Graph Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
      body { margin: 0; padding: 0; background-color:#c9c7c7; }
a:link {
  color: #646d8c;
}
        
/* visited link */
a:visited {
  color: #646d8c;
}   
  
/* mouse over link */
a:hover {
  color: #646d8c;
}
      
a.one:link {color: #e09738; text-decoration: none;}
a.one:visited {color: #e09738;  text-decoration: none;}
a.one:hover {color: #e09738;}
      
a.two:link {color: #646d8c; text-decoration: none; font-size:14px;}
a.two:visited {color: #646d8c;  text-decoration: none; font-size:14px;}
a.two:hover {color: #646d8c; text-decoration: none; font-size:14px;}
	    
	    a.title:link {color: #000000; text-decoration: none;}
a.title:visited {color: #000000;  text-decoration: none;}
a.title:hover {color: #000000; text-decoration: none;}

      
.headerTable
{
    width:100%;
    color:#e09738;
    font-family: arial;
    font-size:12px;
}
      .headline
      {
       font-family:arial;
        font-size:20px;
        color:black; 
      }
      .articleContent
      {
       font-family:arial;
        font-size:13px;
        color:black;
      }
      .imageCaption
      {
       color:#1c1c1c;
       font-style: italic;
        font-siz:12px;
      }
 .horizontal_dotted_line{
  border-bottom: 4px dotted;
  width: 95%;
   text-align:center;
   margin: auto;
} 

       /* Navbar container */
.navbar {
  overflow: hidden;
  background-color: #333;
  font-family: Arial;
}

/* Links inside the navbar */
.navbar a {
  float: left;
  font-size: 16px;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

/* The dropdown container */
.dropdown {
  float: left;
  overflow: hidden;
}

/* Dropdown button */
.dropdown .dropbtn {
  font-size: 16px;
  border: none;
  outline: none;
  color: white;
  padding: 14px 16px;
  background-color: inherit;
  font-family: inherit; /* Important for vertical align on mobile phones */
  margin: 0; /* Important for vertical align on mobile phones */
}

/* Add a red background color to navbar links on hover */
.navbar a:hover, .dropdown:hover .dropbtn {
  background-color: orange;
}

/* Dropdown content (hidden by default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  float: none;
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  text-align: left;
}

/* Add a grey background color to dropdown links on hover */
.dropdown-content a:hover {
  background-color: #ddd;
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
} 


    </style>
    
    
  </head>
<body>
  <table class=headerTable>
    <tr>
      <td style='font-size:50px;padding:30px;color:black;width:120px;vertical-align:top;' rowspan=2><a href=index.html class=title>PowerShell<br> & Graph<br>Blog</a></td>
      


    <td style='width:100%;'>
	    <table style='width:100%;'>
		<tr>
	
	      <td style='color:#e09738;padding30px;font-size:15px;height:30px;width:100%;' class=one><br><br>
      
 <div class="navbar">
 
  <div class="dropdown">
    <button class="dropbtn">Articles
      <i class="fa fa-caret-down"></i>
    </button> 
    <div class="dropdown-content">
	<a href="o365reporting.html" class=two>Reporting on successful Azure logons</a>
	<a href="iisQueue.html" class=two>IIS Mapi Queue full with NetScaler</a>
        <a href="o365cert.html" class=two>Secure Office365 reports with a certifificate</a>
        <a href="graphMail.html" class=two>Using Graph to send emails with inline images</a>
        <a href="charts.html" class=two>Visualizing Graph data with Google Charts</a>
        <a href="alwaysOn.html" class=two>Keeping a log of NetScaler AlwaysON connections</a>
        <a href="DNScleanup.html" class=two>Cleaning up your Windows DNS server</a>
    </div>
  </div>
    <a href="about.html">About</a>
  <a href="links.html">Links</a>
</div> 

 
        
      </td>
 </tr>
    <tr>
    
      <td style='padding-right:200px; width:100%;'><div class=headline id="AzureLogons"><br><b>Keeping a log of NetScaler AlwaysON connections</b></div>
        <div class=articleContent>While there is an option to buy an Citrix reporting add-on my customer did not want the expense of a subscription but still wanted to keep a track on connected clients. 
		After Covid19 struck the AlwaysOn VPN solution became even more important than before.<br>
		<br>
		How to report on the usage with PowerShell? Thankfully there is the Nitro API which interacts well with PowerShell. Originally I was pinging a whole subnet to find connected clients, but with Nitro I could skip this step and see who was connected at a point in time.
		 We now knew who was connected, but we needed to find out what user was logged in to the server. For stability we enabled remote PowerShell as the older commands can fail without timing out. 
		Running the script every 15 minutes we could see what clients were connecting and disconnecting and log this.<br>
		<br>
		<img src=alwaysOn02.png>
		<div class=ImageCaption>Using stored credentials we can get a list of sessions from the NetScaler.</div>
		<br>
		<br>
		<img src=alwaysOn01.png>
		<div class=ImageCaption>We can check what ISP the users connect with and if they have MFA enabled.</div>
		<br>
		During the course of the script there were 2 issues:
		<li>Mass disconnects of all clients</li>
		<li>DNS not updating on clients</li>
		<br>
		For the first issue I was not involved in troubleshooting but I could report to the Citrix admin of a mass disconnection event within a time range of 15 minutes. This helped the admin isolate the issue more quickly. 
		For the DNS issue where the VPN clients could not update their A record we found that the fix from Citrix took so long that we had to implement our own temporary fix. We had the IP's that were connected via Nitro, so this allowed us to use remote PowerShell to query the registry and find the real hostname of the computer connected to the VPN. 
		 With this information we could then update the DNS servers, again with PowerShell. After a few tweaks the script worked as designed and no issues were reported until we got our final fix from Citrix.<br>
		
		<br>
          <br><br> 
                  <div class=tags>Tags: NetScaler, Nitro API</div><br>
		    <div class=tags>Posted: 26-Jan-22</div><br>
                  <br>
                  <div class="horizontal_dotted_line"></div><br>
                  <br>
        </div>
	      
	  
	    </td>
	</tr>
	</table>
	      
      </td>
    </tr>
  </table>
</body>
</html>

