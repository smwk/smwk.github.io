<html>
  <head>
  <title>PowerShell & Graph Blog</title>
    <style>
      body { margin: 0; padding: 0; background-color:#c9c7c7; }
a:link {
  color: #646d8c;
}

/* visited link */
a:visited {
  color: #646d8c;
}

/* mouse over link */
a:hover {
  color: #646d8c;
}
      
a.one:link {color: #e09738; text-decoration: none;}
a.one:visited {color: #e09738;  text-decoration: none;}
a.one:hover {color: #e09738;}
.headerTable
{
    width:100%;
    color:#e09738;
    font-family: arial;
    font-size:12px;
}
      .headline
      {
       font-family:arial;
        font-size:20px;
        color:black; 
      }
      .articleContent
      {
       font-family:arial;
        font-size:13px;
        color:black;
      }
      .imageCaption
      {
       color:#1c1c1c;
       font-style: italic;
        font-siz:12px;
      }
 .horizontal_dotted_line{
  border-bottom: 4px dotted;
  width: 95%;
   text-align:center;
   margin: auto;
} 

      li {
  color: #000;
  background: #c9c7c7;
  display: block;
  float: left;
  padding: 1rem;
  font-size:20px;
  position: relative;
  text-decoration: none;
  transition-duration: 0.5s;
}
  
li a {
  color: #000;
}

li:hover,
li:focus-within {
  background: #c9c7c7;
  cursor: pointer;
}

li:focus-within a {
  outline: none;
}

ul li ul {
  background: orange;
  visibility: hidden;
  opacity: 0;
  min-width: 400px;
  position: absolute;
  font-size: 14px;
  transition: all 0.5s ease;
  margin-top: 1rem;
  left: 0;
  display: none;
}

ul li:hover > ul,
ul li:focus-within > ul,
ul li ul:hover,
ul li ul:focus {
  visibility: visible;
  opacity: 1;
  display: block
}

ul li ul li {
  clear: both;
  width: 100%;
}

    </style>
    
    
  </head>
<body>
  <table class=headerTable>
    <tr>
      <td style='font-size:50px;padding:30px;color:black;width:120px;vertical-align:top;' rowspan=2>PowerShell<br> & Graph<br>Blog</td>
      
    </tr>
    <tr>
      <td style='color:#e09738;padding30px;font-size:15px;height:30px;' class=one>
      

<nav role="navigation">
  <ul>
    
    <li><a href="#" class=one>Articles</a>
      <ul class="dropdown">
        <li><a href="#AzureLogons">Reporting on successful Azure logons</a></li>
        <li><a href="#2">Secure Office365 reports with a certifificate</a></li>
        <li><a href="#3">Using Graph to send emails with inline images</a></li>
        <li><a href="#4">Visualizing Graph data into Google Charts</a></li>
      </ul>
    </li>
    <li><a href=about.html class=one>About</a></li>
    <li><a href=links.html class=one>Links</a></li>
  </ul>
</nav>
 </tr>
    <tr>
      <td></td>
      <td style='padding-right:200px;'><div class=headline id="AzureLogons"><b>Reporting on successful Azure logons</b></div><br>
        <div class=articleContent>The best way to protect users in Azure is to enable 2 factor authentication, but this can take time to setup and enforce for all users. One of the extra checks you can perform is to look at the Azure sign-in logs using MS Graph. This will give you a list of logons to all Azure services, showing the username, country and IP. Using this information Microsoft provide <a href='https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection'>alerts</a> for suspicious logons, for example where a logon was detected from a country not normally seen.<br>
        <br>
        These alerts can be very useful but oddly this only works where the records shows an IPv4 address, if the user logged on using an IPv6 address it will not detect the country. So using a PowerShell script we can do the following:<br>
         <br>
          &#8226;  Report on all users logged in successfully in a 24 hour period.<br>
          &#8226;  Do IPv6 country lookups, something Microsoft does not currently do.<br>
          &#8226;  Exclude certain countries from the report, eg you might not be interested in logons from your home country.<br>
          &#8226;  Send an alert email if suspicious logons are detected.<br>
          <br>
          <img src=image01.png alt="Image of logons detected">
          <div class=ImageCaption>Alert email to show logons from certain countries.</div>
                  <br>
                  <br>
                  <div class=tags>Tags: IPv4 Graph PowerShell</div><br>
                  <br>
                  <div class="horizontal_dotted_line"></div><br>
                  <br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
