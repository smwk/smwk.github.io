<html>
  <head>
  <title>PowerShell & Graph</title>
    <style>
      body { margin: 0; padding: 0; background-color:#c9c7c7; }
a:link {
  color: #646d8c;
}

/* visited link */
a:visited {
  color: #646d8c;
}

/* mouse over link */
a:hover {
  color: #646d8c;
}
      
a.one:link {color: #e09738; text-decoration: none;}
a.one:visited {color: #e09738;  text-decoration: none;}
a.one:hover {color: #e09738;}
.headerTable
{
    width:100%;
    color:#e09738;
    font-family: arial;
    font-size:12px;
}
      .headline
      {
       font-family:arial;
        font-size:20px;
        color:black; 
      }
      .articleContent
      {
       font-family:arial;
        font-size:13px;
        color:black;
      }
      .imageCaption
      {
       color:#1c1c1c;
       font-style: italic;
        font-siz:12px;
      }
 .horizontal_dotted_line{
  border-bottom: 4px dotted;
  width: 95%;
   text-align:center;
   margin: auto;
} 
      
       /* Dropdown Button */
.dropbtn {
  color: #e09738;
  padding: 16px;
  font-size: 15px;
  border: none;
  cursor: pointer;
}

/* Dropdown button on hover & focus */
.dropbtn:hover, .dropbtn:focus {
  background-color: #2980B9;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd}

/* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
.show {display:block;} 
    </style>
    
    <script>
      /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function myFunction() {
  document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
} 
      
    </script>
    
    
  </head>
<body>
  <table class=headerTable>
    <tr>
      <td style='font-size:50px;padding:30px;color:black;width:120px;vertical-align:top;' rowspan=2>PowerShell<br> & Graph<br>Blog</td>
      
    </tr>
    <tr>
      <td style='color:#e09738;padding30px;font-size:15px;height:30px;' class=one><b> <div class="dropdown">
  <button onclick="myFunction()" class="dropbtn">Articles</button>
  <div id="myDropdown" class="dropdown-content">
    <a href="#AzureLogons" class=one>Azure logons</a>
    <a href="#" class=one>Link 2</a>
    <a href="#" >Link 3</a>
  </div>
</div> | <a href=about.html class=one>About</a> | <a href=links.html class=one>Links</a></b></td>
    </tr>
    <tr>
      <td></td>
      <td style='padding-right:200px;'><div class=headline id="AzureLogons"><b>Reporting on successful Azure logons</b></div><br>
        <div class=articleContent>The best way to protect users in Azure is to enable 2 factor authentication, but this can take time to setup and enforce for all users. One of the extra checks you can perform is to look at the Azure sign-in logs using MS Graph. This will give you a list of logons to all Azure services, showing the username, country and IP. Using this information Microsoft provide <a href='https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection'>alerts</a> for suspicious logons, for example where a logon was detected from a country not normally seen.<br>
        <br>
        These alerts can be very useful but oddly this only works where the records shows an IPv4 address, if the user logged on using an IPv6 address it will not detect the country. So using a PowerShell script we can do the following:<br>
         <br>
          <li> Report on all users logged in successfully in a 24 hour period.
            <li> Do IPv6 country lookups, something Microsoft does not currently do.
              <li> Exclude certain countries from the report, eg you might not be interested in logons from your home country.
                <li> Send an alert email if suspicious logons are detected.<br>
                 <br>
                  <img src=image01.png alt="Image of logons detected">
                                    <div class=ImageCaption>Alert email to show logons from certain countries.</div>
                  <br>
                  <br>
                  <div class=tags>Tags: IPv4 Graph PowerShell</div><br>
                  <br>
                  <div class="horizontal_dotted_line"></div><br>
                  <br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
