<html>
  <head>
  <title>PowerShell & Graph</title>
    <style>
      body { margin: 0; padding: 0; background-color:#c9c7c7; }

.headerTable
{
    width:100%;
    color:#e09738;
    font-family: arial;
    font-size:12px;
}
      .headline
      {
       font-family:arial;
        font-size:20px;
        color:black;
      }
      .articleContent
      {
       font-family:arial;
        font-size:13px;
        color:black;
      }
      .imageCaption
      {
       color:#1c1c1c;
       font-style: italic;
        font-siz:12px;
      }
 .horizontal_dotted_line{
  border-bottom: 4px dotted;
  width: 85%;
   text-align:center;
} 
    </style>
  </head>
<body>
  <table class=headerTable>
    <tr>
      <td style='font-size:50px;padding:30px;color:black;width:120px;'>PowerShell<br> & Graph</td>
      <td style='color:#e09738;padding30px;font-size:15px;'><b>Articles | About</b></td>
    </tr>
    <tr>
      <td></td>
      <td style='padding-right:200px;'><div class=headline><b>Reporting on successful Azure logons</b></div><br>
        <div class=articleContent>The best way to protect users in Azure is to enable 2 factor authentication, but this can take time to setup and enforce for all users. One of the extra checks you can perform is to check the Azure sign-in logs using MS Graph. This will give you a list of logons, successful or otherwise, to all Azure services, showing the username, country and IP in the record. Using this information Microsoft provide alerts for suspicious logons, for example where a logon was detected from a country not normally seen.<br>
        <br>
        These alerts can be very useful but oddly this only works where the records shows an IPv4 address, if the user logged on using an IPv6 address it will not detect the country. So using a PowerShell script we can do the following:<br>
         <br>
          <li> Report on all users logged in successfully in a 24 hour period.
            <li> Do IPv6 country lookups, something Microsoft does not currently do.
              <li> Exclude certain countries from the report, eg you might not be interested in logons from your home country.
                <li> Send an alert email if suspicious logons are detected.<br>
                 <br>
                  <img src=image01.png alt="Image of logons detected">
                                    <div class=ImageCaption>Alert email to show logons from certain countries.</div>
                  <br>
                  <br>
                  <div class=tags>Tags: IPv4 Graph PowerShell</div><br>
                  <br>
                  <div class="horizontal_dotted_line"></div><br>
                  <br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
