<html>
  <head>
    <title>Graph and PowerShell Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
       
    <style>
      body{
        margin: 0px;
        padding: 0px;
    }
 
h1 {
        margin-top: 0px;
    }

	    ul {
  list-style-position: outside;
}
	  
      .dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  text-align:left;
  background-color: #ffffff;
  font-family:Montserrat, sans-serif;
  font-size:13px;
  min-width: 380px;
  box-shadow: 0px 2px 2px 0px rgba(0,0,0,0.2);
  padding: 6px 6px;
  z-index: 1;
}

.dropdown:hover .dropdown-content {
  display: block;
}
      
	    
a.dropbtn:link {color: #564c4d; text-decoration: none;}
a.dropbtn:visited {color: #564c4d; text-decoration: none;}
a.dropbtn:hover {color: #564c4d; text-decoration: none;}
	    
a.two:link {color: #564c4d; text-decoration: none;}
a.two:visited {color: #564c4d; text-decoration: none;}
a.two:hover {color: #447EAE; text-decoration: none;}
	    
	.content { font-family:verdana; font-size:12px; color:#564c4d; width:850px; text-align:left; }
	.headline { font-family:verdana; font-size:22px; color:#564c4d; width:850px; text-align:left; }
	.datestamp { font-family:verdana; font-size:10px; color:#564c4d; width:850px; text-align:left; }
	.imagecaption { font-style: italic; }
	.imageMain { border: 5px solid #564c4d; }
	.indexTable td { font-family:verdana; font-size:12px; color:#564c4d; }
	.code { font-family: 'Source Code Pro', monospace; font-size:12px; color:#000; border: 2px solid #000; background-color:#cecece; padding:6px; }

	   .table1 td:first-child {
  font-weight: bold;
}
	    
      </style>
    
  </head>
  
  <body>
    
    <table style='width:100%; padding:0px; border-collapse: collapse;'>
      <tr><td style='height:25px; color:#564c4d; width:50%; font-size:25px; font-family:Montserrat, sans-serif; text-align:left;'><a href='index.html' class=dropbtn><img src='giraffe3.png' style='height:55px; padding:10px; vertical-align:middle; border:0px;'>Graph and PowerShell Blog</a></td>
        
        <td style='width:50%; color:#564c4d; font-size:15px; font-family:Montserrat, sans-serif; text-align:right; padding-right:300px;'>
		
		 
	<div class="dropdown">
		<a href='' class="dropbtn">Articles</a>
  <div class="dropdown-content" style='line-height: 1.6;'>
	  <details open>
		    <summary><b>2024</b><br></summary>
		  <a href="azureVM.html" class=two>List Azure Virtual Machines via PowerShell</a><br>
		   <a href="powershellCore.html" class=two>Moving from PowerShell 5.1 to Core</a><br>
		  <a href="canyonRoadlite.html" class=two>Canyon Roadlite 6 2024</a><br>
		  <a href="postfixReceive.html" class=two>Postfix Receive and Forward</a><br>
		  <a href="phpMailer.html" class=two>Installing and configuring PHPMailer</a><br>
		    <a href="postfixRouting.html" class=two>Postfix routing by filtering</a><br>
	<a href="postfixConfig.html" class=two>Advanced Postfix configuration</a><br>
	  <a href="installExchange2019.html" class=two>Installing Exchange 2019 in Azure Landing Zone</a><br>
	  <a href="upgradePHP.html" class=two>Upgrading PHP on Windows</a><br>
	  <a href="postfixRelay.html" class=two>Adding a Postfix server for relay to O365</a><br>
	  <a href="integratedApps.html" class=two>O365 Integrated Apps troubleshooting</a><br>
	  <a href="DominoO365.html" class=two>Domino and O365 Co-existence</a><br>
	  <a href="ADdelegate.html" class=two>Delegate Control in AD</a><br>
	  <a href="hverelay.html" class=two>App mail relay via HVE</a><br>
 <a href="hve.html" class=two>Setting up Mail Relay with HVE</a><br>
    <a href="bimi.html" class=two>Getting BIMI certified</a><br>
    <a href="occam.html" class=two>Orbea Occam SL H30</a><br>
    <a href="freesat.html" class=two>Installing FreeSat and Saorview</a><br>
    <a href="broadband.html" class=two>Changing broadband provider</a><br>
    <a href="DINtimer.html" class=two>Replacing a DIN timer on fuseboard</a><br>
    <a href="desktopNotifications.html" class=two>Outlook Desktop Notifications stop working</a><br>
    <a href="outlookFolders.html" class=two>Outlook folders keep moving sort order</a><br>
    <a href="runbooks.html" class=two>Teams report uploading to SharePoint with Runbooks</a><br>
	  <a href="teamsApplication.html" class=two>Teams PowerShell module can't run CS cmd as App</a><br>
	  </details>
	  
	  <details>

    <summary><b>2023</b><br></summary>
<a href="mapSharedMailbox.html" class=two>Cannot map new Shared Mailboxes in O365</a><br>
	<a href="exchangeCertRenew.html" class=two>Renewing an Exchange 2016 certificate</a><br>
	<a href="compliancePowershell.html" class=two>Connect to Compliance PowerShell behind a Proxy</a><br>
	<a href="sensitivityLabelError.html" class=two>Sensitivity Label not shown in Outlook Client</a><br>
	<a href="roomFinderError.html" class=two>Room Finder Error in Outlook</a><br>
	<a href="teamsRoom.html" class=two>Teams not showing Rooms</a><br>
	<a href="teamsFile.html" class=two>Teams unable to open file</a><br>
	<a href="reviewQuarantine.html" class=two>Unable to review quarantined mails for shared mailbox</a><br>
	<a href="setLocale.html" class=two>Set Locale for various Apps</a><br>
	<a href="delegateSentItems.html" class=two>Delegate Sent Items placed into external Tenant</a><br>
	<a href="microsoftSupport.html" class=two>Overview of Microsoft Support cases</a><br>
	<a href="centralizedMail.html" class=two>When centralized mail sends via O365</a><br>
        <a href="DNScleanup.html" class=two>Cleaning up your Windows DNS server</a><br>
        <a href="oneDriveLocale.html" class=two>Set OneDrive for Business Locale</a><br>
	<a href="o365migration.html" class=two>O365 Migration Tips</a><br>
	<a href="o365reporting.html" class=two>Reporting on successful Azure logons</a><br>
	<a href="iisQueue.html" class=two>IIS Mapi Queue full with NetScaler</a><br>
        <a href="o365cert.html" class=two>Secure Office365 reports with a certificate</a><br>
        <a href="graphMail.html" class=two>Using Graph to send emails with inline images</a><br>
        <a href="charts.html" class=two>Visualizing Graph data with Google Charts</a><br>
        <a href="alwaysOn.html" class=two>Keeping a log of NetScaler AlwaysON connections</a><br>
</details>
  
  </div>
</div>	
		
		| <a href='about.html' class=two>About</a> | <a href='links.html' class=two>Links</a></td></tr> 
      <tr><td style='height:1px; color:#564c4d; width:100%; border-bottom: 1px solid;' colspan=2></td></tr>
      <tr><td style='text-align:center; width:100%; padding-top:30px; padding-left:30px;' colspan=2>
     
	      

         <div class=headline>Moving from PowerShell 5.1 to Core</div>
	      <div class=datestamp>12-Jul-24</div>
        <div class=content><br>
    On my Management Server, I have nearly always used PowerShell 5.1 for scripts. Exchange 2016 will only work with the snap-in called from 5.1 and is not compatible with PowerShell 7 (Core), because of this the scripts that don't require Exchange used 5.1 to make it easier to administer.<br>
          <br>
          Recently though, I've noticed a few scripts no longer working as I update the modules. While I could go back and try to fix the issues it seems to make more sense now to start working towards moving the scripts to PowerShell Core, especially as I will shortly decommission my on-prem Exchange servers.<br>
          <br>
          PowerShell Core is not without it's issues though, especially if you use a service account, with scheduled tasks, with an authenticated web proxy :(. The main issues I had to troubleshoot were:<br>
          <br>
          <li>Replace PowerShellGet with PSResource</li>
          <li>Install modules for all users</li>
          <li>Converting scheduled tasks from 5.1 to Core</li>
          <li>Other general tips</li>
          <br>
          <b>Replace PowerShellGet with PSResourceGet</b><br>
          Installing Modules with the default v1 PowerShellGet module is a frustrating experience, more so if you only have TLS 1.2 enabled on your server and have an authenticated proxy. PSResourceGet is actually version 3 of PowerShellGet but the owners decided to rename it. 
		Before getting into the installation, check your Internet connection is up and running:<br>
		<br>
		          <div class=code>
	  [PowerShell Core run as Admin]<br>
	  ==============================<br>
	  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12<br>
	[System.Net.Http.HttpClient]::DefaultProxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials <i># Use local credentials for proxy authentication</i><br>
		<br>
	 Invoke-WebRequest -uri https://google.com<br>
          </div> 
		<br>
		To install run the following:<br>
          <br>
          <div class=code>
	  Install-Module -Name Microsoft.PowerShell.PSResourceGet -RequiredVersion 1.0.5<br>
          </div> 
          <br>
		<br>
	<b>Install modules for all users</b><br>
          When installing modules you should install them for all users, this means if you run scheduled tasks using a different account it will use the same module that you would use in testing:<br>
          <br>
          <div class=code>
          Install-PSResource -Name MicrosoftTeams -Scope AllUsers<br>
	  Update-PSResource PSFramework -Scope allusers<br>  
	  Update-PSResource PackageManagement -Scope allusers<br>
          </div> 
          <br>
          One thing to note is when you update a module it will leave the old version installed, so it's probably a good idea to cleanup the old versions with the following command:<br>
		<br>
          <div class=code>
          Uninstall-PSResource PSFramework -Version 0.9.25.107 -Scope allusers -SkipDependencyCheck
          </div> 
          <br> 
          Finally, if we want to list the installed modules and also check if there is a newer version we have these commands:<br>
		<br>
          <div class=code>
          Get-InstalledPSResource -Scope AllUsers<br>
          Find-PSResource -Name az -Repository PSGallery<br>
          </div> 
		          <br> 
		<br>
	<b>Converting scheduled tasks from 5.1 to Core</b><br>
	When creating scheduled tasks that use PowerShell I always use Notepad to write down the commands before editing the task, this prevents typos and other types of errors. It's also useful to have the service account password handy as you will need it for each edited task. The only changes you will need to make are changing the PowerShell executable and the script command:<br>
		<br>
		          <div class=code>
          Program: "C:\Program Files\PowerShell\7\pwsh.exe"<br>
	Arguments: -ExecutionPolicy ByPass -File "C:\Scripts\Exchange\script.ps1"<br>		  
          </div> 
     		         <br>
			
		<img src=powershellCore01.png class=ImageMain>
		<div class=ImageCaption>↑ The 'Arguments' field is very small, so better to edit in Notepad first.</div>
		<br>
		
		<br>
	<b>Other General Tips</b><br>
		<li>If using the module Microsoft.Graph in scripts, then don't import the module. The Connect-MGGraph command will already know what features the Azure app can access. If you do import the module, then it can take up to 15 minutes to load all the different parts.</li>
          
			<br><br>
          </div>
          
          </td>
         
        </td></tr>
    </table> 
    

    
    
    
  </body>
  
  
  
</html>
